name: Deploy Backend

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'docker-compose.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Copy backend files via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "backend/*,docker-compose.yml"
          target: "/home/applyquest"
          strip_components: 0

      - name: Deploy with Docker Compose
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/applyquest
            
            # Create .env file if needed (or manage via secrets)
            # echo "POSTGRES_USER=${{ secrets.DB_USER }}" > .env
            
            # Pull latest images (if using specific images) or build
            docker compose up -d --build backend db
            
            # Wait for DB to be ready
            echo "Waiting for database to be ready..."
            for i in {1..30}; do
              if docker compose exec -T db pg_isready -U postgres; then
                echo "Database is ready!"
                break
              fi
              echo "Database not ready yet, waiting... ($i/30)"
              sleep 2
            done
            
            # Run migrations
            docker compose exec -T backend alembic upgrade head
